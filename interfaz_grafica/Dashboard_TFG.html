<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interfaz gráfica. </title>
<style>
  :root { --fg:#222; --muted:#666; --bg:#fff; --card:#f7f7f8; --accent:#0b5; --danger:#c33; --border:#e5e7eb; }
  *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
  body{ margin:0; color:var(--fg); background:var(--bg); }
  .wrap{ max-width:960px; margin:0 auto; padding:16px; }
  h1{ font-size:18px; margin:0; }
  .grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); margin-top:12px; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; }
  .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .big{ font-size:40px; font-weight:700; }
  .muted{ color:var(--muted); font-size:12px; }
  button{ border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
  button[disabled]{ opacity:.6; cursor:not-allowed; }
  button.primary{ background:var(--fg); color:#fff; }
  button.accent{ background:var(--accent); color:#fff; border-color:transparent; }
  button.danger{ background:var(--danger); color:#fff; border-color:transparent; }
  input[type="range"]{ width:100%; }
  pre{ background:#f3f4f6; border:1px solid var(--border); border-radius:12px; padding:12px; overflow:auto; }
  .badge{ display:inline-block; padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="margin-bottom:8px">
    <div>
      <h1>Interfaz gráfica para control de la cinta.</h1>
      <div class="muted">API: <span id="apiBase"></span></div>
    </div>
    <div class="row" style="gap:6px">
      <span class="badge" id="badgeConn">Conexión: —</span>
      <span class="badge" id="badgeModo">Modo: —</span>
      <span class="badge" id="badgeUpd">Actualizado: —</span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div><strong>Objetos detectados</strong></div>
        <button id="btnReset">Reset</button>
      </div>
      <div class="big" id="valObjetos">—</div>
      <div class="muted">Se incrementa cada vez que se detecta un objeto.</div>
    </div>

    <div class="card">
      <div class="row"><strong>Potenciómetro</strong><span class="muted">0–1023</span></div>
      <div class="big" id="valPot">—</div>
      <div class="muted">Aprox. PWM manual: <b id="valPWMApprox">—</b> / 255</div>
    </div>

    <div class="card">
      <div class="row">
        <strong>PWM aplicado</strong>
        <div class="row" style="gap:6px">
          <button id="btnMotorOn" class="accent">Motor ON</button>
          <button id="btnMotorOff" class="danger">Motor OFF</button>
        </div>
      </div>
      <div class="big" id="valPWM">—</div>
      <div class="muted">0–255</div>
    </div>

    <div class="card" style="grid-column: 1 / -1">
      <div class="row">
        <strong>Modo de funcionamiento</strong>
        <div class="row" style="gap:6px">
          <button id="btnManual">Manual</button>
          <button id="btnRemote" class="primary">Remoto</button>
        </div>
      </div>
      <div style="margin:10px 0">
        <input id="rangePWM" type="range" min="0" max="255" value="128" />
        <div class="muted">PWM remoto: <b id="lblPWM">128</b> / 255</div>
      </div>
      <div class="muted">En remoto, el deslizador envía PWM en tiempo real.</div>
    </div>

    <div class="card" style="grid-column: 1 / -1">
      <div class="row"><strong>Estado /status</strong><span class="muted">JSON crudo</span></div>
      <pre id="jsonBox">{}</pre>
    </div>
  </div>
</div>

<script>
  // Configuración 
  const API_BASE = (new URLSearchParams(location.search).get('api')) || 'http://localhost:5000';
  document.getElementById('apiBase').textContent = API_BASE;

  // Helpers
  const $ = (id) => document.getElementById(id);
  const fmt = (n) => (n === null || n === undefined) ? '—' : new Intl.NumberFormat().format(n);
  function since(ts){ if(!ts) return '—'; const s=Math.max(0, Math.floor(Date.now()/1000 - ts)); return s<60? `${s}s` : `${Math.floor(s/60)}m ${s%60}s`; }

  async function api(path, opts={}){
    const res = await fetch(`${API_BASE}${path}`, { method: opts.method||'GET', headers: opts.body? { 'Content-Type':'application/json' } : undefined, body: opts.body? JSON.stringify(opts.body) : undefined });
    if (!res.ok) throw new Error(`${opts.method||'GET'} ${path} → ${res.status}`);
    return res.json();
  }

  // Estado UI para la barra deslizadora en remoto
  let userSliding = false;
  let sendTimer = null;

  function setSliderEnabled(enabled){
    $('rangePWM').disabled = !enabled;
    $('rangePWM').style.opacity = enabled ? '1' : '0.5';
  }

  function setMotorButtonsEnabled(enabled){
    $('btnMotorOn').disabled = !enabled;
    $('btnMotorOff').disabled = !enabled;
    $('btnMotorOn').style.opacity = enabled ? '1' : '0.6';
    $('btnMotorOff').style.opacity = enabled ? '1' : '0.6';
  }

  function scheduleSend(pwm){
    if (sendTimer) clearTimeout(sendTimer);
    sendTimer = setTimeout(() => {
      api('/mode/remote', { method:'POST', body:{ pwm } }).catch(console.warn);
    }, 120); // debounce: envío en “tiempo real” sin saturar
  }

  // Acciones 
  $('btnReset').onclick     = () => api('/reset', { method:'POST' }).catch(console.warn);
  $('btnMotorOn').onclick   = () => api('/motor', { method:'POST', body:{ on:true } }).catch(console.warn);
  $('btnMotorOff').onclick  = () => api('/motor', { method:'POST', body:{ on:false } }).catch(console.warn);

  $('btnManual').onclick = async () => {
    try {
      await api('/mode/manual', { method:'POST' });
      setSliderEnabled(false); // en manual no se usa la barra deslizadora
      setMotorButtonsEnabled(false);
      tick(); // refresco inmediato
    } catch(e){ console.warn(e); }
  };

  $('btnRemote').onclick = async () => {
    try {
      const pwm = parseInt($('rangePWM').value||'0', 10) || 0;
      await api('/mode/remote', { method:'POST', body:{ pwm } }); // entra en remoto con el valor actual
      // En remoto, habilitar controles remotos
      setSliderEnabled(true); 
      setMotorButtonsEnabled(true);
      tick(); // refresco inmediato 
    } catch(e){ console.warn(e); }
  };

  // Barra deslizadora: controla en tiempo real solo en REMOTO
  $('rangePWM').addEventListener('input', (e) => {
    const pwm = parseInt(e.target.value, 10) || 0;
    $('lblPWM').textContent = pwm;
    userSliding = true;
    // Solo tiene efecto real si estamos en remoto; si no, el API lo ignora porque se sigue en manual.
    scheduleSend(pwm);
  });
  $('rangePWM').addEventListener('pointerdown', ()=> userSliding = true);
  $('rangePWM').addEventListener('pointerup',   ()=> userSliding = false);
  $('rangePWM').addEventListener('touchstart',  ()=> userSliding = true, {passive:true});
  $('rangePWM').addEventListener('touchend',    ()=> userSliding = false);
  $('rangePWM').addEventListener('change',      ()=> userSliding = false);

  // Polling de estado
  async function tick(){
    try{
      const st = await api('/status');
      $('jsonBox').textContent = JSON.stringify(st, null, 2);
      $('valObjetos').textContent = fmt(st.objetos);
      $('valPot').textContent = fmt(st.pot);
      $('valPWM').textContent = fmt(st.pwm);
      const approx = Math.round(((st.pot||0)/1023)*255);
      $('valPWMApprox').textContent = isFinite(approx)? approx : '—';
      $('badgeModo').textContent = 'Modo: ' + (st.modo || '—');
      $('badgeConn').textContent = 'Conexión: ' + (st.port ? `${st.port} @ ${st.baud||'-'} bps` : 'no disponible');
      $('badgeUpd').textContent = 'Actualizado: ' + since(st.last_update);

      // Habilitar/deshabilitar según modo
      const remoto = (st.modo === 'REMOTO');
      setSliderEnabled(remoto);
      setMotorButtonsEnabled(remoto);

      // Sincroniza la barra deslizadora solo si no se está arrastrando.
      if (!userSliding && st.modo === 'REMOTO' && typeof st.pwm === 'number') {
        $('rangePWM').value = st.pwm; $('lblPWM').textContent = st.pwm;
      }
    }catch(e){
      $('badgeConn').textContent = 'Conexión: error';
    }
  }

  /// Arranque: por defecto deshabilita controles remotos (el sistema inicia en manual)
  setSliderEnabled(false);
  setMotorButtonsEnabled(false);
  tick();
  setInterval(tick, 1000); // 
</script>
</body>
</html>
